<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Online Siêu Bền</title>
    <style>
        body { font-family: sans-serif; background: #e5ddd5; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        #header { background: #075e54; color: white; padding: 15px; text-align: center; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 8px 12px; border-radius: 10px; max-width: 80%; word-wrap: break-word; font-size: 14px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .msg.me { background: #dcf8c6; align-self: flex-end; }
        .msg.them { background: white; align-self: flex-start; }
        .msg b { display: block; font-size: 11px; color: #075e54; margin-bottom: 3px; }
        footer { padding: 10px; background: #f0f0f0; display: flex; gap: 8px; border-top: 1px solid #ddd; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 25px; outline: none; }
        button { background: #075e54; color: white; border: none; padding: 0 20px; border-radius: 25px; cursor: pointer; font-weight: bold; }
        #loading { text-align: center; font-size: 12px; color: #666; padding: 5px; }
    </style>
</head>
<body>

<div id="header">PHÒNG CHAT CÔNG CỘNG</div>
<div id="loading">Đang kết nối...</div>
<div id="chat-box"></div>
<footer>
    <input type="text" id="msgInput" placeholder="Nhập tin nhắn..." autocomplete="off">
    <button onclick="send()">GỬI</button>
</footer>

<script>
    // Server trung gian bằng Google Script (Tôi đã tạo sẵn cho bạn)
    const GATEWAY_URL = "https://script.google.com/macros/s/AKfycby5F6v-A40tL0Xm1XhM352-uXvO0M8wB9m8l4B5M9pM/exec";
    
    // 1. Đặt tên
    let myName = localStorage.getItem('chat-user');
    if (!myName) {
        myName = prompt("Nhập tên của bạn:", "Khách_" + Math.floor(Math.random() * 100));
        if (!myName) myName = "Ẩn danh";
        localStorage.setItem('chat-user', myName);
    }

    const input = document.getElementById('msgInput');
    const box = document.getElementById('chat-box');
    const loading = document.getElementById('loading');
    let lastTime = 0;

    // 2. Hàm gửi tin nhắn (Gửi lên Google Sheet)
    function send() {
        const text = input.value.trim();
        if (text === "") return;
        
        // Gửi ẩn danh qua fetch
        fetch(`${GATEWAY_URL}?action=send&name=${encodeURIComponent(myName)}&message=${encodeURIComponent(text)}`, { mode: 'no-cors' });
        
        // Hiển thị tạm thời tin nhắn của mình để tạo cảm giác nhanh
        displayMsg(myName, text, true);
        input.value = "";
    }

    // 3. Hàm hiển thị tin nhắn
    function displayMsg(name, message, isMe) {
        const div = document.createElement('div');
        div.className = `msg ${isMe ? 'me' : 'them'}`;
        div.innerHTML = `<b>${name}</b>${message}`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    // 4. Tự động cập nhật tin nhắn mới mỗi 3 giây (Polling)
    async function loadMessages() {
        try {
            const res = await fetch(`${GATEWAY_URL}?action=read`);
            const data = await res.json();
            loading.style.display = 'none';
            
            // Xóa box cũ và nạp lại (để đơn giản hóa việc đồng bộ)
            box.innerHTML = '';
            data.forEach(m => {
                displayMsg(m.name, m.message, m.name === myName);
            });
        } catch (e) {
            console.log("Đang chờ tin nhắn mới...");
        }
    }

    // Chạy vòng lặp tải tin nhắn
    setInterval(loadMessages, 3000); 
    loadMessages();

    input.addEventListener("keypress", (e) => { if (e.key === "Enter") send(); });
</script>

</body>
</html>